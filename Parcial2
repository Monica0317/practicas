SERVIDOR
sudo ufw allow 21/tcp
sudo ufw allow 20000:21000/tcp 
sudo ufw allow out on eth1 to 192.168.50.2 port 21
sudo ufw enable

sudo vim /etc/sysctl.conf
net.ipv4.ip_forward=1

sudo sysctl -p
sudo vim /etc/ufw/before.rules
-A PREROUTING -i eth0 -p tcp --dport 21 -j DNAT --to-destination 192.168.50.2:21
-A PREROUTING -i eth0 -p tcp --dport 50000:50050 -j DNAT --to-destination 192.168.50.2
-A POSTROUTING -o eth1 -j MASQUERADE

Explicación: En PREROUTING, se usa DNAT para redirigir tráfico entrante de la interfaz pública (eth0) hacia el servidor FTP que está en el puerto 21 de la IP 192.168.50.2. Después se hace lo mismo pero para los puertos pasivos de ftp que son desde 50000–50050. En la cadena POSTROUTING, se aplica MASQUERADE en la interfaz de salida (eth1), lo que permite que el servidor interno navegue hacia afuera usando la IP pública del firewall. En resumen, estas reglas exponen servicios internos hacia Internet y aseguran que las respuestas puedan volver a los clientes externos.

sudo ufw reload

CLIENTE
sudo apt-get update
sudo apt install vsftpd -y

sudo vim /etc/vsftpd.conf
# Configuración básica de seguridad 
listen=YES 
listen_ipv6=NO 
anonymous_enable=NO 
local_enable=YES 
write_enable=YES 
local_umask=022

# Configuración SSL/TLS para FTP Seguro (FTPS) 
ssl_enable=YES 
allow_anon_ssl=NO 
force_local_data_ssl=YES 
force_local_logins_ssl=YES 
ssl_tlsv1=YES 
ssl_sslv2=NO 
ssl_sslv3=NO 
rsa_cert_file=/etc/ssl/private/vsftpd.pem

pasv_enable=YES
pasv_min_port=50000
pasv_max_port=50050
pasv_address=192.168.50.3 

Crear certificado SSL para FTPS:
 sudo openssl req -x509 -nodes -days 365 -newkey rsa:2048 \
-keyout /etc/ssl/private/vsftpd.pem \
-out /etc/ssl/private/vsftpd.pem \
-subj "/C=CO/ST=Valle/L=Cali/O=UAO/CN=ftp.servicios.com"
sudo chmod 600 /etc/ssl/private/vsftpd.pem

# Crear usuario FTP de prueba
sudo adduser ftpuser

# Crear directorio FTP para el usuario
sudo mkdir -p /home/ftpuser/ftp/upload
sudo chown nobody:nogroup /home/ftpuser/ftp
sudo chmod a-w /home/ftpuser/ftp
sudo chown ftpuser:ftpuser /home/ftpuser/ftp/upload

# Reiniciar servicio
sudo systemctl restart vsftpd

Verificar logs del servicio ftp en el Cliente cuando se acceda por filezilla:
sudo tail -f /var/log/vsftpd.log

SEGUNDA PARTE
CLIENTE (192.168.50.2)

sudo vim /etc/sysctl.conf
sudo cat /etc/sysctl.conf | grep ip_forward 
net.ipv4.ip_forward=1
Esta línea sirve para habilitar el reenvío de paquetes IPv4

sudo sysctl -p

sudo ufw status numbered

sudo ufw allow 53 Permite conexiones entrantes en el puerto 53 (DNS).
sudo ufw allow out 53 Permite conexiones salientes en el puerto 53.


sudo vim /etc/ufw/before.rules
sudo cat /etc/ufw/before.rules
Agregar:

*nat 
:PREROUTING ACCEPT [0:0] 
:POSTROUTING ACCEPT [0:0] 

-A PREROUTING -p udp --dport 53 -j DNAT --to-destination 192.168.50.4:53
-A PREROUTING -p tcp --dport 53 -j DNAT --to-destination 192.168.50.4:53
Redirige todo lo que llegue al puerto 53 (UDP y TCP) de la máquina hacia el servidor DNS real en 192.168.50.4:53.
-A POSTROUTING -o eth1 -d 192.168.50.4 -p udp --dport 53 -j MASQUERADE
-A POSTROUTING -o eth1 -d 192.168.50.4 -p tcp --dport 53 -j MASQUERADE
Cambia la IP de origen de los paquetes que se redirigen hacia 192.168.50.4, de manera que ese servidor ve como origen a la máquina (192.168.50.2) y responde a ella.
 
COMMIT

Reiniciar servicio ufw:
sudo ufw disable 
sudo ufw enable

Prueba desde CMD Windows:
PS C:\Users\HP> nslookup maestro.empresa.local 192.168.50.2
Servidor:  cliente.empresa.local
Address:  192.168.50.2

Nombre:  maestro.empresa.local
Address:  192.168.50.3


TERCERA PARTE
esclavo

sudo vim /etc/systemd/resolved.conf

[Resolve]
DNS=1.1.1.1 1.0.0.1
FallbackDNS=8.8.8.8 8.8.4.4
Domains=~.
DNSSEC=yes
DNSOverTLS=yes


si NetworkManager no está disponible 
sudo systemctl restart systemd-resolved

Enlace para que resolv.conf apunte a la configuración que hicimos en systemd-resolved:
sudo ln -sf /run/systemd/resolve/stub-resolv.conf /etc/resolv.conf

Comando para consultar a google: dig google.com
Abrir la interfaz wi-fi en wireshark

Explicación captura wireshark


El cliente establece una conexión TCP segura con el servidor DNS en el puerto 853, lo que indica el inicio de una sesión de DNS sobre TLS.

TLSv1.3  Client Hello
TLSv1.3  Server Hello, Change Cipher Spec, Application Data

El cliente (tu VM 192.168.1.6) inicia la negociación TLS y el servidor (1.1.1.1) responde con su certificado y parámetros de cifrado.
Esto es lo que garantiza que las consultas DNS estarán cifradas.

TLSv1.3  Application Data
TLSv1.3  Application Data

Toda esta sección son consultas y respuestas DNS encapsuladas en TLS.
Ya no puedes leer los dominios en texto plano (como ocurriría en UDP/53), lo que demuestra que la privacidad está protegida.

